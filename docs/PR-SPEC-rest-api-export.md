# PR Spec: Implement REST API Export Endpoints — SATORI Audit

**Target Branch:**  
`main`

**New Feature Branch:**  
`codex/rest-api-export`

**Summary:**  
Implement REST API endpoints that allow secure programmatic access to SATORI Audit report data.  
This PR introduces read-only endpoints for exporting:
- Report metadata  
- Rendered HTML  
- Plugin update history  
- Basic service and diagnostic fields  

This PR **must not** implement write/update endpoints or authentication mechanisms beyond WordPress core capabilities and nonces.

No UI changes.  
No PDF/notification/automation logic.  

---

## Goals

- Create a REST API namespace for SATORI Audit:
  - `/wp-json/satori-audit/v1/`
- Provide endpoints:
  - `/reports` → list reports
  - `/reports/{id}` → get report metadata
  - `/reports/{id}/html` → full rendered HTML
  - `/reports/{id}/updates` → plugin update history
- Enforce capabilities:
  - `capability_view_reports` required for all endpoints

---

## Endpoints Specification

### 1. List Reports  
`GET /wp-json/satori-audit/v1/reports`

Returns:
```
[
  {
    "id": 123,
    "title": "October 2025 Report",
    "date": "2025-10-31",
    "permalink": "...",
    "status": "publish"
  },
  ...
]
```

### 2. Get Report Metadata  
`GET /wp-json/satori-audit/v1/reports/{id}`

Returns:
```
{
  "id": 123,
  "title": "October 2025 Report",
  "date": "2025-10-31",
  "summary": "...",
  "service_settings": { ... },
  "display_settings": { ... },
  "diagnostics": { ... }
}
```

### 3. Get Rendered HTML  
`GET /wp-json/satori-audit/v1/reports/{id}/html`

Returns:
- Fully rendered HTML (string)
- Generated by `Reports::get_report_html()`

### 4. Get Plugin Updates  
`GET /wp-json/satori-audit/v1/reports/{id}/updates`

Returns:
- Array from `Plugins_Service::get_plugin_update_history()`

---

## Changes Required

### 1. New REST API Controller  
File:  
`includes/class-satori-audit-rest-api.php`

Class: `Satori_Audit\REST_API`  
Methods:

- `public static function register_routes()`
- `public static function list_reports()`
- `public static function get_report( WP_REST_Request $request )`
- `public static function get_report_html( WP_REST_Request $request )`
- `public static function get_report_updates( WP_REST_Request $request )`
- `private static function check_permissions()`

Register routes using:

```php
register_rest_route( 'satori-audit/v1', '/reports', ... );
register_rest_route( 'satori-audit/v1', '/reports/(?P<id>\d+)', ... );
register_rest_route( 'satori-audit/v1', '/reports/(?P<id>\d+)/html', ... );
register_rest_route( 'satori-audit/v1', '/reports/(?P<id>\d+)/updates', ... );
```

---

### 2. Register Controller  
In `satori-audit.php`:

```php
add_action( 'rest_api_init', [ '\\Satori_Audit\\REST_API', 'register_routes' ] );
```

---

### 3. Capability Enforcement

All endpoints must require:

```
current_user_can( $settings['capability_view_reports'] )
```

If denied → return:

```json
{
  "code": "satori_audit_forbidden",
  "message": "You do not have permission to access SATORI Audit data.",
  "status": 403
}
```

---

### 4. Logging (debug_mode only)

When `debug_mode = 1`, log:

- Endpoint calls  
- Report ID requested  
- Permission denials  
- Render time (optional)

Use `satori_audit_log()`.

---

## Acceptance Criteria

- All endpoints return correct data with valid report IDs.
- Invalid or forbidden access returns 403 JSON response.
- HTML endpoint returns the same HTML used by admin preview.
- Update history endpoint returns structured array.
- No UI changes.
- No PDF/notification/automation logic.
- No PHP warnings, notices, or fatal errors.
